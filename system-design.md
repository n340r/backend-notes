# System Design

В отличие от **leetcode алгосов** и платформенным задачам на **event loop / рутины / каналы / промисы** и тд. ИИ **очень плохо** помогает с сисдизом.
Промптить в процессе практически **бесполезно** тк уточнения, вопросы от интервьюиера сыпятся **каждые пару мин**. **Проверено** на нескольких реалных собесах.

**Хорошие новости**: ни один реальный сисдиз **не проходит** как на видосах. Настолько глубоко никто не копает, чаще всего хотят получить ответ
на буквально пару вопросов, удостовериться что ты **в целом мыслишь и рассуждаешь правильно**, знаешь **базовые понятия**, **реагируешь** на вопросы и уточнения.

**Лучшая тактика**, которой предерживался я:

1. Посмотреть предложенные ниже видосы, начать замечать паттерны (ага, тут **точно** postgres, тут **точно** через Kafka, тут **не** нужно websocket )
2. Разобрать базовые понятия, технологии, протоколы (Postgres, Mongo, Clickhouse, Cassandra, графовая бд, Kafka, LoadBalancing, gPRC, WebSockets
   - то что в большинстве видосов)
3. Разумеется ходить на собесы и практиковаться. ГПТ можно держать рядом только для базовых вопросов.

## База, советы

### Как начать:

Требования, границы системы: функциональные, нефункциональные. Что оставляфем за скобками, что обсуждаем.

**Функциональные** - буквально функции систмы: бронь отеля, создание отеля, создание свободного номера
в отеле, аутентификация и система оплаты за скобками.

**Нефункциональные** - какая задержка, как быстро хотим получать бронировать, как быстро должна грузиться  
 лента отелей после поиска по датам и тд.

### Проговариваем базовый API

4. Архитектура и модель данных. Важно **не закапываться в детали**

user --> service --> database (монолит) - это **плохо**

Обращаться к изначальным требованиям в ходе дизайна

### (В самом конце) отказоустойчивость, масштабируемость, корнер-кейсы

Нетривиальные моменты + придумываем что может прйти не так:

- А что если бд ляжет ?
- А что если этот сервис не будет работать ?
- Сможем ли масштабироваться если было **X**, а стало **5X**

## Как просто делать подсчеты

**Зачем** вообще мы это делаем ? Не потому что так в видосах, а потому что правильные расчеты помогут понять какой
из компонентов будет **узким горлышком**: API, БД, сокет-содинения, очередь, нужно ли CDN и тд

**Что нужно посчитать**:

- Traffic (Нагрузка на API Gateway)
- RPS (Request Per Second) - нагрузка по ручкам конкретных сервисов
- Storage (Нагрузка на БД, Кэш)

**Что спрашивать**:

Или делать допущения "допустим, у нас такая-то доля рынка, то есть столько-то пользователей"

- DAU (Daily Active Users)

- **Как считать**:

- 1**GB** = 1 x 1000 **MB** = 1 x 1000 x 1000 **KB** = 1 x 1000 x 1000 x 1000 **byte**
- `86_400` - 24 часа в секундах
- Пиковая нагрузка ~ `x10` от средней

**Пример (сервис броня отлей)**:

Дано: 20K отелей, 1M комнат, 60% заполненность, 3 дня в среднем проживание, 100% - 10% - 1% воронка сайт - страница брони - бронь.

Допусим, мы работаем на мир
допустим, у нас такая-то доля рынка, олучаем столько-то пользователей
Допустиим из них DAU - **500_000**
Допустим каждый пользователь делает по 2-4 запроса на начальной странице поиска.

**Считаем RPS**

- 500_000 x 4 = **2_000_000 запросов на поиск день**. 2_000_000 / 86_400 = **23.15 RPS средний поиска**. 23.15 x 10 = **232 RPS пик поиска**
- 500_000 x 0.10 = **50_000 просмотров страницы бронирования**. 50_000 / 86_400 ~ **0.58 RPS средний страницы брони** ~ 0.58 x 10 ~ **6 RPS пик стрицы брони**
- 500_000 x 0.01 = **5000 броней в ДЕНЬ**. 5000 / 86_400 = 0.05 ~ **0.058 RPS средняя брони**. 0.058 x 10 ~ **0.6 RPS пик брони**

**Считаем Traffic**

Traffic (bytes/sec) = RPS x (avg_response_size + avg_request_size)

Допустим, request_booking_page - 2KB
Допустим response_booking_page (ids, даты, цена, статусы, мета) - 30KB

Допустим, request_search_page ~ 2KB
Допустим, response_search_page ~ 50KB

search_page_traffic ≈ 232 × 52KB ≈ 12,064 KB/s ≈ **11.8 MB/s**
booking_page_traffic = 5.8 × 32KB = **185.6 KB/s**

**Считаем память**

На примере бронирований

Допустм, индексы x3 от данных

DB x growth/day ≈ 5,000 x 1KB = **5MB/day**
DB x growth/year ≈ 5MB x 365 ≈ **1.8GB/year**. 1.8 x 3 ~ **6GB данных с индексами каждый год**

**Считаем кэш**

Тут важно что кэшируем

**Считаем кэш**

Тут важно что кэшируем, как, по TTL ? Примерно уточняфем размер данных, всспоминаем сколько их одновременно может быть,

## Что точно нужно упомянуть

1. Кэширование (практически у любой бд)
2. Балансировка нагрузки (можно сразу перед сходом в систему рисовать load balancer)
3. Очереди, gRPC (понимать как общаются микросервис-микросервис, бэкенд-клиент)
4. Репликация, партицирование, шардирование
5. Микросервисы (Монолит никогда не проектируют)
6. Паттерны, подходы. Точно нужно знать
   - Transactional outbox/inbox
   - Dead Letter Exchange
   - Long polling vs открыть сокет соединение
   - Знать концепцию воркера (некий воркер который периодически проверяет что-либо, очищает что-либо)

## Супер популярные типы задачь

(От самоый популярной):

1. Мессенджеры, real-time матчмейкинг, уведомления, RSS
2. Соцсети (твитер, facebook)

(Далее менее популярные)

3. Транзакционные (бронирования, банки)
4. Хранение данных (гугл диск)
5. Медиа системы: YouTube, Netflix, Spotify
6. геоданные (такси, пробки)

## Типичные ошибки и как исправить

- Размышления все ВСЛУХ.
- Медленный расчет, нужно порядок величин.
- Четкие ограничения системы, не распыляться.
- Самостоятельность, ответственность, говори что делаем, веди интервьюиера.
- Все конспектировать. Не записывать - плохо
- Только Critical Path: больше всего логики, больше всего нагрузки
- Объяснять выбор технологий. Объяснение "я его больше знаю" - плохо
- Не игнорировать тайминг.
- Не зубрить готовые архитектуры, быть готовым к вопросам влево-вправо.
- Реагировать на наводящие вопросы !
- Не предлагать варианты вместо решений. Надо четко говорить что и почему.
- Страх попросить помощи. Не тупи - попроси помощи
- Если не знаешь - не нужно делать вид, только закапаешь себя, лучше спросить, упростить.
- Идеальных архитектур НЕТ. Всегда чем-то платим.
- Встречные вопросы, спросить интервьюера а как у них в компании

## Некоторые видео, которые мне очень нравятся

### [Индус когда какую БД использовать](https://www.youtube.com/watch?v=cODCpXtPHbQ)

- Ахуенно, обязательно к просмотру. **Все подряд с этого** канала можно смотреть.

---

### [Индус twitter](https://www.youtube.com/watch?v=EkudBdvbDhs)

- База сисдиза. Тоже супер понятно. Много полезных концепций про кэширование
- **Дополнительно разбери**:
  - **famous person problem** как именно ее решают в соцсетях

---

### [Балун Мок](https://www.youtube.com/watch?v=hCg4N-r_kF0&list=WL&index=5)

_Озон тимлид с лгбт микро и бородатый чел сверху_

- Крутая мысль начинать с базовой архитектуры: user --> service --> DB и нальше копать
- Чел мыслит в целом норм
- Много много пиздит, упоминает миллиард какие-то алгоритмов, мало по делу как будто.

---

### [Индус real-time notification](https://www.youtube.com/watch?v=CUwt9_l0DOg&t=230s)

- Была похожая задача в реальной жизни

---

### [Индус url-shortener](https://www.youtube.com/watch?v=AVztRY77xxA&t=975s)

- Довольно простая, полезно

---

### [Поломодов бронь отелей](https://www.youtube.com/watch?v=Wh5Ya6UFG1k&list=WL&index=14&t=4503s)

- В коментах плюются, но мне понравилось - чел стройно стелит
- **Дополнительно разбери**:
  - А как считать нагрузку при его входных данных ?
  - А что за виртуальный шардинг
  - Что в случае отелей будет являться optimistick lock / pessimistic lock.

---
