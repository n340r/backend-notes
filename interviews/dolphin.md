# –ê—Ä–º—è–Ω–µ

## –ü–æ—á–µ–º—É OFFSET –≤ Postgres —ç—Ç–æ —á–∞—â–µ –≤—Å–µ–≥–æ –ø–ª–æ—Ö–æ ?

`LIMIT/OFFSET` –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç Postgres –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç—Ä–æ–∫–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –Ω—É–∂–Ω—ã.  
–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ 50 (OFFSET ~ 1000) –ë–î:

- –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç—ã—Å—è—á—É —Å—Ç—Ä–æ–∫, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Ö,
- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ LIMIT.
- –ß–µ–º –¥–∞–ª—å—à–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Üí —Ç–µ–º –±–æ–ª—å—à–µ —Å—Ç—Ä–æ–∫ –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ ‚Üí –ª–∏–Ω–µ–π–Ω–æ–µ —É—Ö—É–¥—à–µ–Ω–∏–µ O(n) - **! –ø–ª–æ—Ö–æ !**

‚úÖ –•–æ—Ä–æ—à–æ

–î–µ–ª–∞–µ–º keyset pagination:

- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –µ—Å—Ç—å –∏–Ω–¥–µ–∫—Å –ø–æ –∫–æ–ª–æ–Ω–∫–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–æ–±—ã—á–Ω–æ id).
- –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π id `:last_id` —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
- –°–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –±—Ä–∞—Ç—å —Ç–∞–∫:

```sql
SELECT * FROM hotels
WHERE id > :last_id
ORDER BY id
LIMIT 20;
```

## –ó–∞–ø—Ä–æ—Å —Å –±–æ–ª—å—à–∏–º –∫–æ–ª-–≤–æ–º _.JOIN_, –æ–Ω —Å—Ç–∞–ª –≤ 10 —Ä–∞–∑ –º–µ–¥–ª–µ–Ω–Ω–µ–µ - –ø–æ—á–µ–º—É ? –ö–∞–∫ —á–∏–Ω–∏—Ç—å ?

1. `EXPLAIN ANALYZE`

- –∫–∞–∫–æ–π —Ç–∏–ø JOIN
- –Ω–∞ –∫–∞–∫–æ–º –º–µ—Å—Ç–µ –¥–æ–ª–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ?
- –ï—Å—Ç—å –ª–∏ —Ä–∞–∑–ª–∏—á–∏–µ _estimated rows_ vs _actual rows_ ?

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É `ANALYZE`
3. –ü—Ä–æ–ø–∞–ª –∏–Ω–¥–µ–∫—Å (–º–∏–≥—Ä–∞—Ü–∏–∏, —Å–º–µ–Ω–∞ —Ç–∏–ø–∞ –∫–æ–ª–æ–Ω–∫–∏, —É–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ —Å–ª—É—á–∞–π–Ω–æ)
4. –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–∞–º—è—Ç–∏ –∏ "–ø—Ä–æ–ª–∏–≤–∞–µ—Ç—Å—è" –Ω–∞ –¥–∏—Å–∫
5. –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ "–ø–æ –∫–æ–ª–æ–Ω–∫–∞–º" —ç—Ç–æ –∫–æ–≥–¥–∞ –Ω–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ø–æ —Ç–µ–º, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –¥–µ–ª–∞–µ–º `.JOIN`, `.WHERE`
6. index bloat

–¢–µ–ø–µ—Ä—å —á—Ç–æ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –∏ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–∑–Ω–∏–∫—à–∏–µ –≤–æ–ø—Ä–æ—Å—ã:

- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –æ —Ç–∞–±–ª–∏—Ü–µ / —Ç–∞–±–ª–∏—Ü–∞—Ö (–ø—Ä–∏–º–µ—Ä–Ω–æ —Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫,  
  –∫–æ–ª-–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π, —á–∞—Å—Ç–æ—Ç–∞ –∑–Ω–∞—á–µ–Ω–∏—è). –ï–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, –æ–Ω–∞ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –Ω–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ.  
  –ª–∏–±–æ –≤—Ä—É—á–Ω—É—é `ANALYZE`, –ª–∏–±–æ `autovacuum`. –ï—Å–ª–∏ —Ä–µ–∑–∫–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∫—É—á–∞ `UPDATE`, –ª–∏–±–æ `INSERT`, —Ç–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  –µ—â–µ –Ω–µ —É—Å–ø–µ–ª–∞ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è.
- `autovacuum` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–≥—Ä–∞—É–Ω–¥ –ø—Ä–æ—Ü–µ—Å –≤ –ø–æ—Å—Ç–≥—Ä–µ—Å–µ
- _estimated rows_ vs _actual rows_ - —ç—Ç–æ —Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ "–æ–∂–∏–¥–∞–µ—Ç" –ø–æ–ª—É—á–∏—Ç—å –∏ —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.  
  –ï—Å–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å—Ç–∞—Ä–µ—à–∞, –æ–Ω –æ–∂–∏–¥–∞–µ—Ç –Ω–µ —Ç–æ, —Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–Ω–æ –ø–ª–æ—Ö–æ–π –ø–ª–∞–Ω.
- `index blot` - postgres –Ω–µ —á–∏—Å—Ç–∏—Ç –∏ –Ω–µ –ø–µ—Ä–µ–±–∏—Ä–∞–µ—Ç –∏–Ω–¥–µ–∫—Å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –∏–Ω–∞—á–µ –±—ã–ª–æ –±—ã –¥–æ—Ä–æ–≥–æ.  
  –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∫—É—á–∞ `UPDATE`, `DELETE` –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ "–º–µ—Ä—Ç–≤—ã–µ", –Ω–æ –µ—â–µ –Ω–µ —É—Å–ø–µ–≤–∞—é—Ç –≤—ã–∫–∏–Ω—É—Ç—å—Å—è –∏–∑ –∏–Ω–¥–µ–∫—Å–∞. –ò–∑–±–µ–≥–∞–µ—Ç—Å—è `autovacuum`, `VACUUM`
- hash join –ø—Ä–æ–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –¥–∏—Å–∫. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ —Ö—ç—à-—Ç–∞–±–ª–∏—Ü—ã –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–∞–º—è—Ç—å –∏ postgres, –æ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç
  –ø–∏—Å–∞—Ç—å —á–∞—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –¥–∏—Å–∫, –∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –¥–∏—Å–∫—É _(–¥–∞–∂–µ SSD)_ –≤ —Å–æ—Ç–Ω–∏ –º–Ω–æ–≥–æ —Ä–∞–∑ –º–µ–¥–ª–µ–Ω–Ω–µ–µ —á–µ–º –∫ RAM.

## –ü–æ—á–µ–º—É –∑–∞–ø—Ä–æ—Å —Å '\*' –º–µ–¥–ª–µ–Ω–Ω—ã–π –¥–∞–∂–µ —Å –∏–Ω–¥–µ–∫—Å–æ–º ?

`SELECT * ...` –º–µ–¥–ª–µ–Ω–Ω—ã–π, –ø–æ—Ç–æ–º—É —á—Ç–æ Postgres –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–µ–ª–∞–µ—Ç heap fetch ‚Äî —á–∏—Ç–∞–µ—Ç –≤—Å—é —Å—Ç—Ä–æ–∫—É
–∏–∑ —Ç–∞–±–ª–∏—Ü—ã, –Ω–µ –∏–∑ –∏–Ω–¥–µ–∫—Å–∞. –ò–Ω–¥–µ–∫—Å –ø–æ–º–æ–≥–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É, –∞ –Ω–µ –≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏.  
–ü—Ä–æ–±–ª–µ–º–∞ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω–∞—è, –ø–æ—ç—Ç–æ–º—É –ª—É—á—à–µ –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è.

## —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ JOIN

–µ—Å—Ç—å –≤ –∫–æ–Ω—Å–ø–µ–∫—Ç–µ

## –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å deadlock —Å–≤–æ–∏–º–∏ —Ä—É–∫–∞–º–∏

–ü—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä –∫–æ–≥–¥–∞ 2 —Ä–∞–∑–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∫–∞ –Ω–∞—á–∏–Ω–∞—é—Ç –æ–¥–Ω–∞ —Å `id=1`, –∞ –≤—Ç–æ—Ä–∞—è —Å `id=2` –∏ –ø–æ—Ç–æ–º –ª–µ–∑—É—Ç –¥—Ä—É–≥ –∫ –¥—Ä—É–≥—É

## –†–µ–ø–ª–∏–∫–∞—Ü–∏—è —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ

| –ú–µ—Ö–∞–Ω–∏–∑–º              | –ú–∞—Å—à—Ç–∞–±              | –¶–µ–ª—å                        | –ü—Ä–∏–º–µ—Ä                  |
| --------------------- | -------------------- | --------------------------- | ----------------------- |
| **–†–µ–ø–ª–∏–∫–∞—Ü–∏—è**        | –∫–æ–ø–∏–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤       | –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ —á—Ç–µ–Ω–∏–µ | Primary ‚Üí Replica       |
| **–®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ**      | —Ä–∞–∑–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã       | –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –æ–±—ä—ë–º—É   | `user_id % 3`           |
| **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** | –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã | —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤          | `created_at` –ø–æ –º–µ—Å—è—Ü–∞–º |

## –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —á—Ç–æ ORDER BY –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—ã–¥–∞—á–∏ ?

```sql
SELECT id FROM (
  SELECT id FROM users ORDER BY created_at DESC LIMIT 10
) sub;
```

–ö–∞–∂–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ –≤–µ—Ä–Ω—ë—Ç "10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
–Ω–æ PostgreSQL (–∏ –¥—Ä—É–≥–∏–µ –°–£–ë–î) –∏–º–µ—é—Ç –ø—Ä–∞–≤–æ –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω –∏ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ORDER BY,
–ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É SQL).

> üí° –ß—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ ‚Äî ORDER BY –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Å–∞–º–æ–º –≤–Ω–µ—à–Ω–µ–º —Å–ª–æ–µ:

```sql
SELECT id FROM (
  SELECT id, created_at FROM users
) sub
ORDER BY created_at DESC
LIMIT 10;
```
